<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器渲染 | enaoi&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="vue、react、webpack...，everything about front development.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" href="/assets/css/0.styles.14f0b62d.css" as="style"><link rel="preload" href="/assets/js/app.dc2a0576.js" as="script"><link rel="preload" href="/assets/js/2.11d19bd3.js" as="script"><link rel="preload" href="/assets/js/45.aca6880f.js" as="script"><link rel="prefetch" href="/assets/js/10.98c47988.js"><link rel="prefetch" href="/assets/js/11.d7c912d5.js"><link rel="prefetch" href="/assets/js/12.5baf646b.js"><link rel="prefetch" href="/assets/js/13.57e81f3e.js"><link rel="prefetch" href="/assets/js/14.e6de5925.js"><link rel="prefetch" href="/assets/js/15.d11de5dd.js"><link rel="prefetch" href="/assets/js/16.96516270.js"><link rel="prefetch" href="/assets/js/17.a3706a5a.js"><link rel="prefetch" href="/assets/js/18.8a7cbfdc.js"><link rel="prefetch" href="/assets/js/19.35b33062.js"><link rel="prefetch" href="/assets/js/20.a768ccec.js"><link rel="prefetch" href="/assets/js/21.de7c3de9.js"><link rel="prefetch" href="/assets/js/22.91ae7333.js"><link rel="prefetch" href="/assets/js/23.c195e0fd.js"><link rel="prefetch" href="/assets/js/24.f1a0be61.js"><link rel="prefetch" href="/assets/js/25.830768c8.js"><link rel="prefetch" href="/assets/js/26.ecdbaa22.js"><link rel="prefetch" href="/assets/js/27.c11eb401.js"><link rel="prefetch" href="/assets/js/28.e1d2ae6d.js"><link rel="prefetch" href="/assets/js/29.7dbe41bc.js"><link rel="prefetch" href="/assets/js/3.8bd42a0a.js"><link rel="prefetch" href="/assets/js/30.dba9760a.js"><link rel="prefetch" href="/assets/js/31.eb44f132.js"><link rel="prefetch" href="/assets/js/32.82188c4f.js"><link rel="prefetch" href="/assets/js/33.70bd62c4.js"><link rel="prefetch" href="/assets/js/34.e61aa4d5.js"><link rel="prefetch" href="/assets/js/35.88fc4055.js"><link rel="prefetch" href="/assets/js/36.1f27c2c8.js"><link rel="prefetch" href="/assets/js/37.bffcb782.js"><link rel="prefetch" href="/assets/js/38.2a3ce61c.js"><link rel="prefetch" href="/assets/js/39.82569ab4.js"><link rel="prefetch" href="/assets/js/4.a201f84c.js"><link rel="prefetch" href="/assets/js/40.610237f4.js"><link rel="prefetch" href="/assets/js/41.e4e5bd18.js"><link rel="prefetch" href="/assets/js/42.b68fb12b.js"><link rel="prefetch" href="/assets/js/43.e9a1fbf0.js"><link rel="prefetch" href="/assets/js/44.86703b4b.js"><link rel="prefetch" href="/assets/js/46.633acbd7.js"><link rel="prefetch" href="/assets/js/47.b29718ef.js"><link rel="prefetch" href="/assets/js/48.083797ae.js"><link rel="prefetch" href="/assets/js/49.3975f53b.js"><link rel="prefetch" href="/assets/js/5.8d87159a.js"><link rel="prefetch" href="/assets/js/50.e66ec424.js"><link rel="prefetch" href="/assets/js/51.3a322244.js"><link rel="prefetch" href="/assets/js/52.f2f66746.js"><link rel="prefetch" href="/assets/js/53.50f2084a.js"><link rel="prefetch" href="/assets/js/54.eed8c1a4.js"><link rel="prefetch" href="/assets/js/55.32fb1514.js"><link rel="prefetch" href="/assets/js/56.49cc5939.js"><link rel="prefetch" href="/assets/js/57.14c5862b.js"><link rel="prefetch" href="/assets/js/58.3406a0cd.js"><link rel="prefetch" href="/assets/js/59.e075b367.js"><link rel="prefetch" href="/assets/js/6.17ee8618.js"><link rel="prefetch" href="/assets/js/60.b948c23c.js"><link rel="prefetch" href="/assets/js/61.cb54f658.js"><link rel="prefetch" href="/assets/js/62.fe18928d.js"><link rel="prefetch" href="/assets/js/63.93d08160.js"><link rel="prefetch" href="/assets/js/64.a772b358.js"><link rel="prefetch" href="/assets/js/65.2a8f9764.js"><link rel="prefetch" href="/assets/js/66.848d69fd.js"><link rel="prefetch" href="/assets/js/67.eb9dfa5a.js"><link rel="prefetch" href="/assets/js/68.5e23b4a2.js"><link rel="prefetch" href="/assets/js/69.4ec0d823.js"><link rel="prefetch" href="/assets/js/7.c0ab16fe.js"><link rel="prefetch" href="/assets/js/70.9ed535aa.js"><link rel="prefetch" href="/assets/js/71.d4c96826.js"><link rel="prefetch" href="/assets/js/72.cadb8b3c.js"><link rel="prefetch" href="/assets/js/73.299cc5b8.js"><link rel="prefetch" href="/assets/js/74.57dc718f.js"><link rel="prefetch" href="/assets/js/75.b8b21f84.js"><link rel="prefetch" href="/assets/js/76.714894d7.js"><link rel="prefetch" href="/assets/js/77.beebd88c.js"><link rel="prefetch" href="/assets/js/78.23d6ade9.js"><link rel="prefetch" href="/assets/js/79.b2aef682.js"><link rel="prefetch" href="/assets/js/8.b476c428.js"><link rel="prefetch" href="/assets/js/80.ddc1dd90.js"><link rel="prefetch" href="/assets/js/9.05ba9cfe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.14f0b62d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">enaoi's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/javascript/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">
  Tools
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中级" class="dropdown-title"><span class="title">中级</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          MVVM框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-subitem"><a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-subitem"><a href="/angular/" class="nav-link">
  angular
</a></li></ul></li><li class="dropdown-item"><h4>
          扩展
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/typescript/" class="nav-link">
  TypeScript
</a></li></ul></li><li class="dropdown-item"><h4>
          打包工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-subitem"><a href="/vite/" class="nav-link">
  vite
</a></li></ul></li><li class="dropdown-item"><h4>
          知识
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/http/" class="nav-link">
  Http
</a></li><li class="dropdown-subitem"><a href="/libs/" class="nav-link">
  库
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="高级" class="dropdown-title"><span class="title">高级</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          后端服务
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nodejs/" class="nav-link">
  nodejs
</a></li><li class="dropdown-subitem"><a href="/koa/" class="nav-link">
  koa
</a></li><li class="dropdown-subitem"><a href="/express.html" class="nav-link">
  express
</a></li></ul></li><li class="dropdown-item"><h4>
          数据结构和算法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/datastructures/" class="nav-link">
  数据结构
</a></li><li class="dropdown-subitem"><a href="/algorithm/" class="nav-link">
  算法
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="阅读" class="dropdown-title"><span class="title">阅读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/reading/" class="nav-link">
  文学类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/vscode/" class="nav-link">
  vscode
</a></li></ul></li><li class="dropdown-item"><h4>
          其它
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/computer/" class="nav-link">
  计算机
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/enaoi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/javascript/" class="nav-link router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">
  Tools
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中级" class="dropdown-title"><span class="title">中级</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          MVVM框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-subitem"><a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-subitem"><a href="/angular/" class="nav-link">
  angular
</a></li></ul></li><li class="dropdown-item"><h4>
          扩展
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/typescript/" class="nav-link">
  TypeScript
</a></li></ul></li><li class="dropdown-item"><h4>
          打包工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-subitem"><a href="/vite/" class="nav-link">
  vite
</a></li></ul></li><li class="dropdown-item"><h4>
          知识
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/http/" class="nav-link">
  Http
</a></li><li class="dropdown-subitem"><a href="/libs/" class="nav-link">
  库
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="高级" class="dropdown-title"><span class="title">高级</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          后端服务
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nodejs/" class="nav-link">
  nodejs
</a></li><li class="dropdown-subitem"><a href="/koa/" class="nav-link">
  koa
</a></li><li class="dropdown-subitem"><a href="/express.html" class="nav-link">
  express
</a></li></ul></li><li class="dropdown-item"><h4>
          数据结构和算法
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/datastructures/" class="nav-link">
  数据结构
</a></li><li class="dropdown-subitem"><a href="/algorithm/" class="nav-link">
  算法
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="阅读" class="dropdown-title"><span class="title">阅读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/reading/" class="nav-link">
  文学类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/git/" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/vscode/" class="nav-link">
  vscode
</a></li></ul></li><li class="dropdown-item"><h4>
          其它
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/computer/" class="nav-link">
  计算机
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/enaoi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/javascript/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/javascript/menu_01_basicDataType.html" class="sidebar-link">基础数据类型</a></li><li><a href="/javascript/menu_02_this.html" class="sidebar-link">执行上下文与 this</a></li><li><a href="/javascript/menu_03_regex.html" class="sidebar-link">正则表达式</a></li><li><a href="/javascript/menu_04_window.html" class="sidebar-link">浏览器对象</a></li><li><a href="/javascript/menu_05_resource_load.html" class="sidebar-link">浏览器资源加载</a></li><li><a href="/javascript/menu_06_browser_render.html" aria-current="page" class="active sidebar-link">浏览器渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/menu_06_browser_render.html#渲染引擎工作流" class="sidebar-link">渲染引擎工作流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/menu_06_browser_render.html#解析" class="sidebar-link">解析</a></li><li class="sidebar-sub-header"><a href="/javascript/menu_06_browser_render.html#构建渲染树" class="sidebar-link">构建渲染树</a></li><li class="sidebar-sub-header"><a href="/javascript/menu_06_browser_render.html#布局" class="sidebar-link">布局</a></li><li class="sidebar-sub-header"><a href="/javascript/menu_06_browser_render.html#绘制" class="sidebar-link">绘制</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/menu_06_browser_render.html#重排和重绘" class="sidebar-link">重排和重绘</a></li><li class="sidebar-sub-header"><a href="/javascript/menu_06_browser_render.html#优化办法" class="sidebar-link">优化办法</a></li></ul></li><li><a href="/javascript/menu_07_javascriptLoad.html" class="sidebar-link">网页解析和脚本执行时间线</a></li><li><a href="/javascript/menu_08_browser_event.html" class="sidebar-link">浏览器事件</a></li><li><a href="/javascript/menu_09_static_resource_update.html" class="sidebar-link">静态资源版本更新与缓存</a></li><li><a href="/javascript/menu_10_closure.html" class="sidebar-link">闭包</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浏览器渲染"><a href="#浏览器渲染" class="header-anchor">#</a> 浏览器渲染</h1> <p>页面加载过程中：</p> <p>浏览器内核包括渲染引擎和JS引擎，由于js引擎越来越独立，内核就倾向于只指渲染引擎。</p> <h2 id="渲染引擎工作流"><a href="#渲染引擎工作流" class="header-anchor">#</a> 渲染引擎工作流</h2> <div class="language-mermaid extra-class"><pre class="language-text"><code>graph LR
A[解析HTML构建DOM树]--&gt;B[构建渲染树]
B--&gt;C[渲染树布局阶段]
C--&gt;D[绘制渲染树]
</code></pre></div><ul><li>将HTML标签解析成由多个DOM元素对象节点组成的且具有节点父子关系的DOM树结构。</li> <li>根据DOM树结构的每个节点顺序提取计算使用的CSS规则并且重新计算DOM树结构的样式数据，生成一个带样式描述的DOM渲染树</li> <li>主要是元素的布局属性生效（position、float、margin等）</li> <li>绘制阶段主要是颜色、背景、文本等样式信息应用到每个节点上。</li></ul> <p><strong>不同浏览器会有些许差异：</strong></p> <p>webkit内核渲染主流程
<img src="evernotecid://500C1910-0299-4C7B-B6B6-34FA452313A8/appyinxiangcom/10638591/ENResource/p559" alt="4e1087aa67d8118109ff1591299d749e.png"></p> <p>google内核渲染主流程
<img src="evernotecid://500C1910-0299-4C7B-B6B6-34FA452313A8/appyinxiangcom/10638591/ENResource/p558" alt="44dded08e412d7965479eb698a2856b8.png"></p> <h3 id="解析"><a href="#解析" class="header-anchor">#</a> 解析</h3> <p>将文档转化为代码可以使用的结构，解析的结果代表了文档结构的节点树，也称为解析树。解析器分两个结构：词法分析和语法分析。词法分析负责将输入内容分解为有效标记符号；语法分析对语言应用语法规则，从而构建解析树。</p> <ol><li>HTML解析器：该阶段结束，浏览器会将文档状态设置为完成，一个加载onload事件将随之触发。</li> <li>CSS解析器</li> <li>处理脚本和样式表的顺序
<ol><li>脚本： 同步，async 和 defer 脚本的加载各有不同。参考之前的文章。</li> <li>预解析：在执行脚本时，其他线程会解析文档的其余部分，找出并加载需要通过网络加载的其他资源。通过这种方式，资源可以在并行连接上加载，从而提高总体速度。预解析器不会修改 DOM 树，而是将这项工作交由主解析器处理；预解析器只会解析外部资源（例如外部脚本、样式表和图片）的引用。</li> <li>样式表：应用样式表不会更改 DOM 树，因此似乎没有必要等待样式表并停止文档解析。但脚本在文档解析阶段会请求样式信息。如果当时还没有加载和解析样式，脚本就会获得错误的回复。解决方案：Firefox， 在样式表加载和解析的过程中，会禁止所有脚本。WebKit，仅当脚本尝试访问的样式属性可能受尚未加载的样式表影响时，才会禁止该脚本。</li></ol></li></ol> <h3 id="构建渲染树"><a href="#构建渲染树" class="header-anchor">#</a> 构建渲染树</h3> <p>**作用：**按照正确的顺序绘制内容。根据 display 属性的不同，针对同一个 DOM 节点应创建什么类型的呈现器。</p> <p><strong>与DOM树区别：</strong>
- 非可视化的 DOM 元素不会插入渲染树中，例如<code>head</code>元素。如果元素的<code>display</code>属性值为<code>none</code>，那么也不会显示在渲染树中（但是<code>visibility</code>属性值为<code>hidden</code>的元素仍会显示）
- 有一些 DOM 元素对应多个可视化对象。它们往往是具有复杂结构的元素，无法用单一的矩形来描述，如<code>select</code>；关于多呈现器的例子是格式无效的 HTML
- 渲染对象对应于 DOM 节点，但在树中所在的位置与 DOM 节点不同：浮动定位和绝对定位的元素</p> <p>**计算样式：**计算渲染对象的可视化属性，就是计算每个元素的样式属性。 难点：样式数据大；元素匹配复杂；应用规则涉及到复杂的层叠规则。css权重：<code>!important</code> &gt; <code>内联样式规则(权重1000)</code> &gt; <code>id选择器(权重100)</code>&gt;<code>类选择器(权重10)</code>&gt;<code>元素选择器(权重1)</code></p> <h3 id="布局"><a href="#布局" class="header-anchor">#</a> 布局</h3> <p>渲染树并不包含位置和大小信息，计算这些信息的过程称为布局或重排。</p> <p>HTML采用基于流的布局模型，只需要遍历一次就可以计算出所有的几何信息。处于流后面位置的元素不会影响前面元素的几何特征。布局可以按照从左至右，从上至下的顺序遍历文档。 布局是个递归的过程，它从根渲染器开始然后递归遍历所有子渲染器，具有子渲染器的渲染器继续递归遍历遍历所有子渲染器。每个渲染器都有一个“layout”或“reflow”方法，每个渲染器都会调用需要进行布局的子代的layout方法。</p> <h4 id="dirty位系统"><a href="#dirty位系统" class="header-anchor">#</a> Dirty位系统</h4> <p>**作用：**避免细小的变化影响整体布局。 如果渲染器发生了变化或者其子代发生了变化就会被标注为”dirty”或children are dirty，需要进行布局。</p> <p><strong>全局布局和增量布局：</strong></p> <ul><li>全局布局：同步执行。影响所有渲染器的全局样式发生了改变，比如size变化；屏幕尺寸发生变化。</li> <li>增量布局：异步执行。只对标记为dirty的渲染器布局。Firefox将增量布局的“reflow 命令”加入队列，调度程序会触发批量触发这些命令。Webkit 有一个定时器来执行增量布局，对渲染树遍历，并对有dirty标记的渲染器进行布局。</li></ul> <h4 id="布局处理"><a href="#布局处理" class="header-anchor">#</a> 布局处理</h4> <ol><li>父呈现器确定自己的宽度</li> <li>父呈现器依次处理子呈现器，并且放置子呈现器（设置 x,y 坐标）。 如果有必要，调用子呈现器的布局（如果子呈现器是 dirty 的，或者这是全局布局，或出于其他某些原因），这会计算子呈现器的高度。</li> <li>父呈现器根据子呈现器的累加高度以及边距和补白的高度来设置自身高度，此值也可供父呈现器的父呈现器使用。</li> <li>将其 dirty 位设置为 false。 宽度计算：呈现器宽度是根据容器块的宽度、呈现器样式中的“width”属性以及边距和边框计算得出的</li></ol> <h3 id="绘制"><a href="#绘制" class="header-anchor">#</a> 绘制</h3> <p>遍历渲染树，并调用渲染器的“paint”方法，将渲染器的内容显示在屏幕上。绘制工具是使用用户界面基本组件完成的。</p> <p><strong>全局绘制和增量绘制：</strong>
在增量绘制中，部分渲染器发生变化不影响整个树。 更改后的呈现器将其在屏幕上对应的矩形区域设为无效，这导致 OS 将其视为一块“dirty 区域”，并生成“paint”事件。OS 会很巧妙地将多个区域合并成一个。在 Chrome 浏览器中，情况要更复杂一些，因为 Chrome 浏览器的呈现器不在主进程上。Chrome 浏览器会在某种程度上模拟 OS 的行为。展示层会侦听这些事件，并将消息委托给呈现根节点。然后遍历呈现树，直到找到相关的呈现器，该呈现器会重新绘制自己（通常也包括其子代）</p> <p><strong>绘制顺序：</strong>
绘制的顺序其实就是元素进入堆栈样式上下文的顺序。这些堆栈会从后往前绘制，因此这样的顺序会影响绘制。块呈现器的堆栈顺：背景颜色，背景图片，边框，子代，轮廓</p> <h2 id="重排和重绘"><a href="#重排和重绘" class="header-anchor">#</a> 重排和重绘</h2> <p>在浏览器中，因为渲染引擎和JS引擎是独立分离的，比如 在IE中，ECMAScrit的实现在jscript.dll中，而DOM的实现在mshtml.dll中；在Chrome中使用WebKit中的 WebCore处理DOM和渲染，但ECMAScript是在V8引擎中实现的，其他浏览器的情况类似。所以通过JavaScript代码调用DOM接口，相当于两个独立模块的交互。相比较在同一模块中的调用，这种跨模块的调用其性能损耗是很高的。但DOM操作对性能影响最大其实还是因为它导致了浏览器的<code>重绘（repaint）</code>和 <code>重排（reflow）</code>。</p> <p>关于重绘和重排对性能的影响：<a href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/" target="_blank" rel="noopener noreferrer">《浏览器的工作原理：新式网络浏览器幕后揭秘》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>重排的代价比重绘的代价高很多，以下操作会导致重绘或重排：</p> <ul><li>增加、删除和修改可见DOM元素</li> <li>页面初始化的渲染</li> <li>移动DOM元素</li> <li>修改CSS样式，改变DOM元素的尺寸</li> <li>DOM元素内容改变，使得尺寸被撑大</li> <li>浏览器窗口尺寸改变</li> <li>浏览器窗口滚动</li></ul> <p>这些操作都是DOM操作中比较常见的。
现代浏览器会针对重排或重绘做性能优化，比如，把DOM操作积累一批后统一做一次重排或重绘。<strong>但在有些情况下，浏览器会立即重排或重绘。</strong></p> <p>比如请求如下的DOM元素布局信息：</p> <ul><li>offsetTop/Left/Width/Height</li> <li>scrollTop/Left/Width/Height</li> <li>clientTop/Left/Width/Height</li> <li>getComputedStyle()/currentStyle</li></ul> <p>因为这些值都是动态计算的，所以浏览器需要尽快完成页面的绘制，然后计算返回值，从而打乱了重排或重绘的优化。</p> <h2 id="优化办法"><a href="#优化办法" class="header-anchor">#</a> 优化办法</h2> <ol><li><p>合并多次的DOM操作为单次的DOM操作</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>element<span class="token punctuation">.</span>style<span class="token punctuation">.</span>borderColor <span class="token operator">=</span> <span class="token string">'#f00'</span><span class="token punctuation">;</span>
element<span class="token punctuation">.</span>style<span class="token punctuation">.</span>borderStyle <span class="token operator">=</span> <span class="token string">'solid'</span><span class="token punctuation">;</span>
element<span class="token punctuation">.</span>style<span class="token punctuation">.</span>borderWidth <span class="token operator">=</span> <span class="token string">'1px'</span><span class="token punctuation">;</span>

<span class="token comment">//good</span>
element<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">+=</span> <span class="token string">'border: 1px solid #f00;'</span><span class="token punctuation">;</span>

<span class="token comment">//best 更利于维护</span>
element<span class="token punctuation">.</span>className <span class="token operator">+=</span> <span class="token string">'empty'</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>使用文档片段createDocumentFragment()</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>fruit<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span> apple <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span> orange <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// js</span>
<span class="token keyword">var</span> lis <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fruit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
li<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'apple'</span><span class="token punctuation">;</span>
lis<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
li<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'watermelon'</span><span class="token punctuation">;</span>
lis<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//两次添加会容易造成页面闪动</span>
<span class="token comment">//优化</span>

<span class="token keyword">var</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
li<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'apple'</span><span class="token punctuation">;</span>
fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
li<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'watermelon'</span><span class="token punctuation">;</span>
fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fruit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>通过隐藏后操作DOM来减少渲染次数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> myElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'myElement'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
<span class="token comment">// 一些基于myElement的大量DOM操作</span>
<span class="token comment">//...</span>
myElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'block'</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>克隆DOM元素到内存中</p> <p>把页面上的DOM元素克隆一份到内存中，然后再在内存中操作克隆的元素，操作完成后使用此克隆元素替换页面中原来的DOM元素。在内存中操作克隆元素不会引起页面上的性能损耗。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> old <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'myElement'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> clone <span class="token operator">=</span> old<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 一些基于clone的大量DOM操作</span>
<span class="token comment">//...</span>
old<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>clone<span class="token punctuation">,</span> old<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>将动画效果的DOM元素脱离页面布局流</p> <ul><li>使用 <strong>绝对位置[absolute或者fixed]</strong> 定位页面上的动画元素，将其脱离文档流</li> <li>让元素动起来。当它扩大时，会临时覆盖部分页面。但这只是页面一个小区域的重绘过程，不会产生重排并重绘页面的大部分内容。</li> <li>当动画结束时恢复定位，从而只会下移一次文档的其他元素</li></ul></li> <li><p>谨慎取得DOM元素的布局信息</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    myElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> targetElement<span class="token punctuation">.</span>offsetTop <span class="token operator">+</span> i<span class="token operator">*</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果存在重复调用，最佳的做法是尽量把这些值缓存在局部变量中</span>

<span class="token keyword">var</span> targetTop <span class="token operator">=</span> targetElement<span class="token punctuation">.</span>offsetTop<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    myElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> targetTop<span class="token operator">+</span> i<span class="token operator">*</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> newWidth <span class="token operator">=</span> div1<span class="token punctuation">.</span>offsetWidth <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
div1<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> newWidth <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> newHeight <span class="token operator">=</span> myElement<span class="token punctuation">.</span>offsetHeight <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 强制页面重排</span>
myElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> newHeight <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span> <span class="token comment">// 又会重排一次</span>

<span class="token comment">// 取得DOM元素的布局信息提前，因为浏览器会优化连续的DOM操作</span>

<span class="token keyword">var</span> newWidth <span class="token operator">=</span> div1<span class="token punctuation">.</span>offsetWidth <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> newHeight <span class="token operator">=</span> myElement<span class="token punctuation">.</span>offsetHeight <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>

div1<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> newWidth <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
myElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> newHeight <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>使用事件托管方式绑定事件</p> <p>在DOM元素上绑定事件会影响页面的性能，一方面，绑定事件本身会占用处理时间，另一方面，浏览器保存事件绑定，所以绑定事件也会占用内存。页面中元素绑定的事件越多，占用的处理时间和内存就越大，性能也就相对越差，所以在页面中绑定的事件越少越好。一个优雅的手段是使用事件托管方式，即利用事件冒泡机制，只在父元素上绑定事件处理，用于处理所有子元素的事件，在事件处理函数中根据传入的参数判断事件源元素，针对不同的源元素做不同的处理。这样就不需要给每个子元素都绑定事件了，管理的事件绑定数量变少了，自然性能也就提高了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 获取父节点，并添加一个click事件</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查事件源元素</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span>toUpperCase <span class="token operator">==</span> <span class="token string">&quot;LI&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 针对子元素的处理 ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// jquery</span>
<span class="token function">$</span><span class="token punctuation">(</span> <span class="token string">&quot;table&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span> <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;td&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 针对子元素的处理 ...</span>
    <span class="token function">$</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toggleClass</span><span class="token punctuation">(</span> <span class="token string">&quot;chosen&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">12/11/2020, 5:06:14 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/javascript/menu_05_resource_load.html" class="prev">
        浏览器资源加载
      </a></span> <span class="next"><a href="/javascript/menu_07_javascriptLoad.html">
        网页解析和脚本执行时间线
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.dc2a0576.js" defer></script><script src="/assets/js/2.11d19bd3.js" defer></script><script src="/assets/js/45.aca6880f.js" defer></script>
  </body>
</html>
